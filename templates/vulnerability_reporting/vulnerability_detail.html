{% extends 'vulnerability_reporting/base2.html' %}
{% load crispy_forms_filters %}

{% block title %}{{ vulnerability.title }}{% endblock %}

{% block extra_css %}
<style>
    .vulnerability-report {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .vulnerability-meta {
        background-color: #f1f3f5;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .comment {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .btn-primary {
        background-color: #007bff;
    }
    .btn-primary:hover {
        background-color: #0056b3;
    }
    .delete-button {
        background-color: #dc3545;
    }
    .delete-button:hover {
        background-color: #b02a37;
    }
    .vulnerability-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
    }
    .content-html p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }
    .content-html ul {
        margin-bottom: 1rem;
        padding-left: 1.5rem;
    }
    .content-html h3 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }

    /* Styling the comment section */
    .comment-box {
        margin-top: 2rem;
    }
    .comment-box h4 {
        font-weight: bold;
        margin-bottom: 1rem;
    }
    .comment-box .form-control {
        border-radius: 8px;
        padding: 10px;
    }
    .comment-box .btn-primary {
        border-radius: 6px;
        padding: 10px 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="vulnerability-report">
        <h1 class="mb-4">{{ vulnerability.title }}</h1>

        <div class="vulnerability-meta mb-4">
            <p><strong>Status:</strong> {{ vulnerability.get_status_display }}</p>
            <p><strong>Severity:</strong> {{ vulnerability.get_severity_display }}</p>
            <p><strong>Reported by:</strong> {{ vulnerability.reported_by.username }}</p>
            <p><strong>Reported at:</strong> {{ vulnerability.reported_at|date:"F d, Y" }}</p>
        </div>

        {% if vulnerability.image %}
        <img src="{{ vulnerability.image.url }}" alt="{{ vulnerability.title }}" class="vulnerability-image mb-3">
        {% endif %}

        <div class="content-html">
            <h3>Description</h3>
            <div>{{ vulnerability.description|safe }}</div>

            <h3>Steps to Reproduce</h3>
            <div>{{ vulnerability.reproduction_steps|safe }}</div>

            <h3>Impact and Risks</h3>
            <div>{{ vulnerability.impact_and_risks|safe }}</div>

            <h3>Affected Components</h3>
            <div>{{ vulnerability.affected_components }}</div>

            <h3>Expected Behavior</h3>
            <div>{{ vulnerability.expected_behavior|safe }}</div>

            <h3>Actual Behavior</h3>
            <div>{{ vulnerability.actual_behavior|safe }}</div>
        </div>

        {% if vulnerability.attachments.all %}
        <h3>Attachments</h3>
        <ul>
            {% for attachment in vulnerability.attachments.all %}
            <li><a href="{{ attachment.file.url }}" class="text-decoration-none" target="_blank">{{ attachment.file.name }}</a></li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="vulnerability-report mt-5">
        <h3 class="mb-4">Comments</h3>
        {% for comment in comments %}
        <div class="comment mb-3">
            <p><strong>{{ comment.user.username }}</strong> - {{ comment.created_at|date:"F d, Y" }}</p>
            <p>{{ comment.content }}</p>
        </div>
        {% empty %}
        <p>No comments yet.</p>
        {% endfor %}

        <div class="comment-box mt-4">
            <h4>Add a Comment</h4>
            <form method="post" action="{% url 'exploits:vulnerability_detail' vulnerability.slug %}">
                {% csrf_token %}
                {{ comment_form|crispy }}
                <button type="submit" class="btn btn-primary mt-2">Add Comment</button>
            </form>
        </div>
    </div>

    {% if request.user == vulnerability.reported_by or request.user.is_staff %}
    <form method="post" action="{% url 'exploits:delete_vulnerability' vulnerability.slug %}" class="mt-4">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this vulnerability?');">Delete Vulnerability</button>
    </form>
    {% endif %}
</div>
{% endblock %}
