{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{% static 'images/logo.png' %}">
    <title>Chat Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* General styles */
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Poppins', sans-serif;
    background-color: #f0f2f5;
}

.container {
    display: flex;
    height: 100vh;
}

/* Sidebar styles */
/* Sidebar styles */
.sidebar {
    width: 300px; /* Fixed width for the sidebar */
    min-width: 300px; /* Prevents the sidebar from compressing */
    background-color: white;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #e0e0e0;
    flex-shrink: 0; /* Ensures sidebar doesn't shrink when space is limited */
}




.sidebar-header {
    padding: 20px;
    background-color: #007bff;
    color: white;
}

.sidebar-content {
    flex-grow: 1;
    overflow-y: auto;
}

.btn {
    display: inline-block;
    padding: 8px 16px;
    margin: 5px;
    background-color: white;
    color: #007bff;
    text-decoration: none;
    border-radius: 20px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    background-color: #e6f2ff;
    transform: translateY(-2px);
}


/* Chat area styles */
.chat-area {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    background-color: #f0f2f5;
    min-width: 0; /* Allows chat area to shrink when needed */
}
.chat-header {
    padding: 20px;
    background-color: #007bff;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
}

.chat-input {
    padding: 20px;
    background-color: white;
    display: flex;
    border-top: 1px solid #e0e0e0;
}

.chat-input input {
    flex-grow: 1;
    padding: 10px 15px;
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    margin-right: 10px;
    font-family: 'Poppins', sans-serif;
}

.chat-input button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.chat-input button:hover {
    background-color: #0056b3;
}

/* Friend list item styles */
.friend-list-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #e0e0e0;
    transition: background-color 0.3s ease;
}

.friend-list-item:hover {
    background-color: #f0f2f5;
}

.friend-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 15px;
}

.friend-info {
    flex-grow: 1;
}

.friend-info h3 {
    margin: 0;
    font-size: 16px;
    color: #007bff;
}

.friend-info p {
    margin: 5px 0 0;
    font-size: 14px;
    color: #65676b;
}

.unread-count {
    background-color: #007bff;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8em;
}

/* Message styles */
.message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 70%;
    position: relative;
}

/* Message styles */
.message.sender {
    background-color: #232529;
    color: white;
    align-self: flex-end;
    margin-left: auto;
}

.message.recipient {
    background-color: #0075f4;
    color: #f8de1d;
    align-self: flex-start;
    border: 1px solid #b3d1ff;
}


.message-timestamp {
    font-size: 12px;
    color: #a8a8ad;
    margin-top: 5px;
    text-align: right;
}

/* Button styles */
.btn-danger {
    background-color: #dc3545;
    color: white;
}

.btn-danger:hover {
    background-color: #c82333;
}

/* Scrollbar styles */
.sidebar-content, .chat-messages {
    scrollbar-width: thin;
    scrollbar-color: #007bff #f0f2f5;
}

.sidebar-content::-webkit-scrollbar, .chat-messages::-webkit-scrollbar {
    width: 6px;
}

.sidebar-content::-webkit-scrollbar-track, .chat-messages::-webkit-scrollbar-track {
    background: #f0f2f5;
}

.sidebar-content::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb {
    background-color: #007bff;
    border-radius: 3px;
}
 /* Android-specific styles */
@media (max-width: 768px) {
    body, html {
        font-family: 'Roboto', sans-serif;
        background-color: #f5f5f5;
        overflow: hidden;
        height: 100%;
        width: 100%;
        position: fixed;
    }

    .container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
    }

    .sidebar {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        transition: transform 0.3s ease-out;
        overflow-y: auto;
    }

    .sidebar.hidden {
        transform: translateX(-100%);
    }

    .chat-area {
        position: absolute;
        left: 100%;
        top: 0;
        width: 100%;
        height: 100%;
        transition: transform 0.3s ease-out;
        display: flex;
        flex-direction: column;
    }

    .chat-area.visible {
        transform: translateX(-100%);
    }

    .chat-header {
        padding: 10px;
        background-color: #007bff;
        color: white;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .chat-input {
        padding: 10px;
        background-color: white;
        border-top: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
    }

    .chat-input input {
        flex: 1;
        border-radius: 20px;
        padding: 8px 12px;
        margin-right: 8px;
        border: 1px solid #e0e0e0;
        font-size: 16px;
    }

    
}

    </style>
</head>
<body data-user-id="{{ request.user.id }}">
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <a class="navbar-brand" href="{% url 'chatzone2:chat_home' %}">
                    <img src="{% static 'images/logo.png' %}" alt="CyberIoT" style="height: 50px;">
                </a>
                <h2>Chats</h2>
                <a href="{% url 'chatzone2:search_users' %}" class="btn">Search Users</a>
                <a href="{% url 'mainpage:main_page' %}" class="btn">Main Page</a>
            </div>
            <div class="sidebar-content">
                {% if friends_data %}
                    {% for friend in friends_data %}
                        <div class="friend-list-item" data-user-id="{{ friend.user.id }}" data-username="{{ friend.user.username }}">
                            <img src="{{ friend.profile.profile_picture.url }}" alt="{{ friend.user.username }}" class="friend-avatar">
                            <div class="friend-info">
                                <h3>{{ friend.user.username }}</h3>
                                <p>{{ friend.last_message.content|default:"No messages yet"|truncatechars:30 }}</p>
                            </div>
                            {% if friend.unread_count > 0 %}
                                <span class="unread-count">{{ friend.unread_count }}</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No friends yet. Try searching for users!</p>
                {% endif %}
            </div>
        </div>
        <div class="chat-area">
            <div id="chat-header" class="chat-header">
                <h2>Select a chat to start messaging</h2>
                <button id="back-button" style="display: none;" class="btn">Back</button>
                <button id="delete-chat" style="display: none;" class="btn btn-danger">Delete Chat</button>
            </div>
            <div id="chat-messages" class="chat-messages"></div>

             <div class="chat-input" id="chat-input" style="display: none;">
                <input type="text" id="message-input" placeholder="Type a message...">
                <!-- Replace the existing send button in the chat-input div -->
                <button id="send-button" aria-label="Send message" style="width: 40px; height: 40px; border-radius: 50%; background-color: #007bff; color: white; border: none; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer;">âž¤</button>

            </div>

        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'chatzone/message.js' %}"></script>
    <script>
       // Assuming jQuery is already loaded
$(document).ready(function() {
    const userId = $('body').data('user-id');
    let currentChatUserId = null;
    let socket = null;

    // Initialize WebSocket connection
    function initializeWebSocket() {
        socket = new WebSocket(`ws://${window.location.host}/ws/chat/${userId}/`);

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.sender_id === currentChatUserId) {
                appendMessage(data.message, 'recipient');
            } else {
                updateUnreadCount(data.sender_id);
            }
        };

        socket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };
    }

    // Function to send a message
    function sendMessage(message) {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                'message': message,
                'recipient_id': currentChatUserId
            }));
        }
    }

    // Function to append a message to the chat
    function appendMessage(message, sender) {
        const messageElement = $('<div>').addClass('message').addClass(sender);
        messageElement.text(message);
        const timestamp = $('<div>').addClass('message-timestamp').text(new Date().toLocaleTimeString());
        messageElement.append(timestamp);
        $('#chat-messages').append(messageElement);
        $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
    }

    // Function to update unread count for a user
    function updateUnreadCount(senderId) {
        const userElement = $(`.friend-list-item[data-user-id="${senderId}"]`);
        let unreadCount = parseInt(userElement.find('.unread-count').text()) || 0;
        unreadCount++;
        userElement.find('.unread-count').text(unreadCount).show();
    }

    // Function to load messages for a user
    function loadMessages(userId) {
        $.ajax({
            url: `/api/messages/${userId}/`,
            method: 'GET',
            success: function(data) {
                $('#chat-messages').empty();
                data.forEach(function(message) {
                    const sender = message.sender_id === currentChatUserId ? 'recipient' : 'sender';
                    appendMessage(message.content, sender);
                });
            },
            error: function(error) {
                console.error('Error loading messages:', error);
            }
        });
    }

    // Event handler for clicking on a friend in the list
    $('.friend-list-item').on('click', function() {
        const userId = $(this).data('user-id');
        const username = $(this).data('username');
        currentChatUserId = userId;

        $('#chat-header h2').text(username);
        $('#chat-input, #delete-chat').show();
        $(this).find('.unread-count').text('').hide();

        loadMessages(userId);

        if ($(window).width() <= 768) {
            $('.sidebar').addClass('hidden');
            $('.chat-area').addClass('visible');
        }
    });

    // Event handler for sending a message
     $('#send-button').on('click', function() {
                const message = $('#message-input').val().trim();
                if (message && currentChatUserId) {
                    sendMessage(message);
                    appendMessage(message, 'sender');
                    $('#message-input').val('');
                }
            });

    // Allow sending message with Enter key
    $('#message-input').on('keypress', function(e) {
        if (e.which === 13 && !e.shiftKey) {
            $('#send-button').click();
            e.preventDefault();
        }
    });

    // Event handler for the back button (mobile view)
    $('#back-button').on('click', function() {
        $('.sidebar').removeClass('hidden');
        $('.chat-area').removeClass('visible');
        currentChatUserId = null;
    });

    // Event handler for deleting a chat
    $('#delete-chat').on('click', function() {
        if (currentChatUserId) {
            if (confirm('Are you sure you want to delete this chat?')) {
                $.ajax({
                    url: `/api/delete-chat/${currentChatUserId}/`,
                    method: 'POST',
                    success: function() {
                        $('#chat-messages').empty();
                        $('#chat-header h2').text('Select a chat to start messaging');
                        $('#chat-input, #delete-chat').hide();
                        currentChatUserId = null;
                        if ($(window).width() <= 768) {
                            $('#back-button').click();
                        }
                    },
                    error: function(error) {
                        console.error('Error deleting chat:', error);
                    }
                });
            }
        }
    });

    // Initialize WebSocket connection
    initializeWebSocket();

    // Show/hide elements based on screen size
    function updateLayout() {
        if ($(window).width() <= 768) {
            $('#back-button').show();
            if (!currentChatUserId) {
                $('.chat-area').removeClass('visible');
                $('.sidebar').removeClass('hidden');
            }
        } else {
            $('#back-button').hide();
            $('.chat-area, .sidebar').removeClass('hidden visible');
        }
    }

    // Update layout on window resize
    $(window).on('resize', updateLayout);

    // Initial layout setup
    updateLayout();
});
    </script>
</body>
</html>