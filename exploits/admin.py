from django.contrib import admin
from .models import Vulnerability, VulnerabilityAttachment, Review, VulnerabilityComment, ExportRequest

@admin.register(Vulnerability)
class VulnerabilityAdmin(admin.ModelAdmin):
    list_display = ('title', 'severity', 'status', 'reported_by', 'resolved_at')
    list_filter = ('severity', 'status', 'resolved_at')
    search_fields = ('title', 'description', 'affected_components', 'reported_by__username')
    prepopulated_fields = {'slug': ('title',)}
    readonly_fields = ('resolved_at',)

    fieldsets = (
        ('Basic Information', {
            'fields': ('title', 'slug', 'description', 'severity', 'status')
        }),
        ('Vulnerability Details', {
            'fields': ('impact_and_risks', 'reproduction_steps', 'affected_components')
        }),
        ('Reporting Information', {
            'fields': ('reported_by', 'is_anonymous', 'reporter_contact', 'resolved_at')
        }),
    )

    def get_readonly_fields(self, request, obj=None):
        if obj:  # editing an existing object
            return self.readonly_fields + ('reported_by',)
        return self.readonly_fields

    def save_model(self, request, obj, form, change):
        if not change:  # If this is a new object
            if not obj.reported_by:
                obj.reported_by = request.user
        super().save_model(request, obj, form, change)


@admin.register(VulnerabilityAttachment)
class VulnerabilityAttachmentAdmin(admin.ModelAdmin):
    list_display = ('vulnerability', 'file', 'uploaded_by', 'uploaded_at')
    list_filter = ('uploaded_at',)
    search_fields = ('vulnerability__title', 'uploaded_by__username')


@admin.register(Review)
class ReviewAdmin(admin.ModelAdmin):
    list_display = ('vulnerability', 'reviewer', 'status', 'reviewed_at')
    list_filter = ('status', 'reviewed_at')
    search_fields = ('vulnerability__title', 'reviewer__username', 'comments')


@admin.register(VulnerabilityComment)
class VulnerabilityCommentAdmin(admin.ModelAdmin):
    list_display = ('vulnerability', 'user', 'created_at')
    list_filter = ('created_at',)
    search_fields = ('vulnerability__title', 'user__username', 'content')


@admin.register(ExportRequest)
class ExportRequestAdmin(admin.ModelAdmin):
    list_display = ('user', 'vulnerability', 'start_date', 'end_date', 'requested_at', 'completed_at', 'is_completed')
    list_filter = ('is_completed', 'requested_at', 'completed_at')
    search_fields = ('user__username', 'vulnerability__title')
    readonly_fields = ('requested_at',)

    fieldsets = (
        ('Request Information', {
            'fields': ('user', 'vulnerability', 'start_date', 'end_date')
        }),
        ('Status', {
            'fields': ('is_completed', 'requested_at', 'completed_at')
        }),
    )
